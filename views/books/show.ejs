<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/style.css" />
  <title><%= book.title %> - Book Details</title>
  <style>
    .book-container {
      max-width: 935px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .book-header {
      display: flex;
      padding: 1rem;
      align-items: center;
      border-bottom: 1px solid rgba(139, 92, 246, 0.1);
    }

    .book-content {
      display: grid;
      grid-template-columns: 60% 40%;
      min-height: 600px;
    }

    .book-image {
      background: linear-gradient(135deg, #9b6dff20, #6c2bd920);
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid rgba(139, 92, 246, 0.1);
    }

    .book-image svg {
      width: 120px;
      height: 120px;
      color: #8b5cf6;
      opacity: 0.6;
    }

    .book-details-sidebar {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
    }

    .book-meta-info {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(139, 92, 246, 0.1);
    }

    .reviews-section {
      flex: 1;
      overflow-y: auto;
      max-height: 400px;
    }

    .review-card {
      padding: 1rem;
      border-bottom: 1px solid rgba(139, 92, 246, 0.1);
    }

    .review-author {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .review-form {
      padding: 1rem;
      background: rgba(139, 92, 246, 0.05);
      border-radius: 10px;
      margin-top: 1rem;
    }

    .review-form textarea {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      margin: 1rem 0;
      min-height: 100px;
      resize: vertical;
    }
  </style>
</head>

<body>
  <div class="container">
    <%- include('../partials/_navbar.ejs') %>

    <div class="book-container">
      <div class="book-header">
        <h1 style="margin: 0; font-size: 1.5rem;"><%= book.title %></h1>
      </div>

      <div class="book-content">
        <div class="book-image">
          <% if (book.imageUrl) { %>
          <img src="<%= book.imageUrl %>" alt="<%= book.title %>" style="width: 100%; height: 100%; object-fit: contain;">
          <% } else { %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg>
          <% } %>
        </div>

        <div class="book-details-sidebar">
          <div class="book-meta-info">
            <h2 class="book-author">By <%= book.author %></h2>
            <span class="book-status <%= book.status === 'Read' ? 'status-read' : 'status-want' %>">
              <%= book.status %>
            </span>

            <% if (book.rating) { %>
            <div class="book-rating">
              <span class="rating-label">Rating:</span>
              <span class="rating-stars">
                <% for(let i = 0; i < book.rating; i++) { %>‚≠ê<% } %>
                (<%= book.rating %>/5)
              </span>
            </div>
            <% } %>

            <div class="book-actions" style="margin-top: 1rem;">
              <% if (user && book.userId._id.toString() === user._id.toString()) { %>
              <a href="/books/<%= book._id %>/edit" class="btn-small btn-edit">
                <span>‚úèÔ∏è Edit Book</span>
              </a>
              <% } %>
              <a href="/books" class="btn-small btn-view">
                <span>üìö Back to Books</span>
              </a>
            </div>
          </div>

          <!-- Review Modal -->
          <div id="reviewModal" class="modal">
            <div class="modal-content">
              <span class="close">&times;</span>
              <h4>Add Your Review</h4>
              <form action="/books/<%= book._id %>/reviews" method="POST" class="review-form">
                <select name="rating" style="margin: 0.5rem 0;" required>
                  <option value="" disabled selected>Select Rating</option>
                  <option value="1">1 ‚≠ê</option>
                  <option value="2">2 ‚≠ê‚≠ê</option>
                  <option value="3">3 ‚≠ê‚≠ê‚≠ê</option>
                  <option value="4">4 ‚≠ê‚≠ê‚≠ê‚≠ê</option>
                  <option value="5">5 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                </select>
                <textarea name="comment" placeholder="Write your review..." required></textarea>
                <button type="submit">Submit Review</button>
              </form>
            </div>
          </div>

          <div class="reviews-section">
            <h2>Reviews</h2>
            <% if (book.reviews && book.reviews.length > 0) { %>
            <% book.reviews.forEach(review => { %>
            <div class="review-card">
              <p class="review-author"><%= review.username %></p>
              <div class="review-rating">
                <% for(let i = 0; i < review.rating; i++) { %>‚≠ê<% } %>
              </div>
              <p class="review-comment"><%= review.comment %></p>
              <% if (user && review.userId && review.userId._id.toString() === user._id.toString()) { %>
              <div class="review-actions">
                <a href="/books/<%= book._id %>/reviews/<%= review._id %>/edit" class="btn-small btn-edit">Edit</a>
                <form action="/books/<%= book._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" style="display:inline;">
                  <button type="submit" class="btn-small btn-delete">Delete</button>
                </form>
              </div>
              <% } %>
            </div>
            <% }) %>
            <% } else { %>
            <p>No reviews yet</p>
            <% } %>

          </div>

          <button id="openReviewModal" class="add-review-btn" style="
            background: #9b6dff;
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 10px;
            font-size: 1rem;
         ">Add Review</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get the modal
    var modal = document.getElementById("reviewModal");

    // Get the button that opens the modal
    var btn = document.getElementById("openReviewModal");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks the button, open the modal 
    btn.onclick = function() {
      modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
      modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }
  </script>

</body>

</html>